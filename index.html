<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- Meta viewport con user-scalable=no para evitar zoom accidental -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>DreamTouch</title>
  <!-- Shim para evitar error de require -->
  <script>
    window.require = function() {};
  </script>
  <!-- Scripts MIDI y soundfont (versión 0.12.0 desde cdn.jsdelivr.net) -->
  <script src="https://cdn.jsdelivr.net/npm/webmidiapishim"></script>
  <script src="https://cdn.jsdelivr.net/npm/webmidi@2"></script>
  <script src="https://cdn.jsdelivr.net/gh/gasman/jasmid@master/stream.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gasman/jasmid@master/midifile.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
  <style>
    /* … estilos existentes … */
    /* Agregamos un estilo sencillo para el botón del pedal */
    #pedalBtn {
      background-color: #ADD8E6;
      color: black;
      padding: 8px 15px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Botón de pantalla completa -->
    <button id="fullscreenBtn">⛶</button>
    <h1>DreamTouch</h1>
    <div id="copyright">
      <a href="https://www.youtube.com/@rafgim" target="_blank" style="color: inherit; text-decoration: none;">© By Rafael Gimeno</a>
    </div>
    <!-- Área de toque -->
    <div id="touchBox">
      <div id="dynamicMarkingsContainer">
        <div>Fortissimo</div>
        <div>Forte</div>
        <div>Mezzo-forte</div>
        <div>Mezzo-piano</div>
        <div>Piano</div>
        <div>Pianissimo</div>
      </div>
    </div>
    <!-- Controles inferiores -->
    <div id="buttons">
      <label for="midiFile" id="loadButton">
        Cargar Archivo MIDI
        <input type="file" id="midiFile" accept=".mid,.midi,audio/midi,audio/x-midi,application/x-midi">
      </label>
      <div id="sampleSongsContainer">
        <label for="sampleSongs">Canciones de muestra:</label>
        <select id="sampleSongs">
          <option value="">-- Selecciona una canción --</option>
          <option value="Bach Minueto.mid">Bach - Minueto.mid</option>
          <option value="Bach Musette.mid">Bach - Musette.mid</option>
          <option value="Beethoven Claro de luna.mid">Beethoven - Claro de luna.mid</option>
          <option value="Beethoven Para Elisa.mid">Beethoven Para Elisa.mid</option>
          <option value="Beethoven Patética.mid">Beethoven - Patética.mid</option>
          <option value="Clementi Sonatina.mid">Clementi - Sonatina.mid</option>
          <option value="Mozart Sonata KV 545 2nd Mov.mid">Mozart - Sonata KV 545 2nd Mov.mid</option>
          <option value="Gustavo Pascual Paquito el chocolatero.mid">Gustavo Pascual - Paquito el chocolatero.mid</option>
          <option value="Handel & Halvorsen Passacaglia.mid">Handel & Halvorsen - Passacaglia.mid</option>
          <option value="R.Korsakov El vuelo del moscardón.mid">R.Korsakov - El vuelo del moscardón.mid</option>
          <option value="Rachmaninoff Concert nº2 Tercer mov.mid">Rachmaninoff - Concert nº2 Tercer mov.mid</option>
          <option value="Satie Gymnopedie n1.mid">Satie - Gymnopedie n1.mid</option>
        </select>
      </div>
      <!-- Botón para alternar Pedal ON/OFF -->
      <button id="pedalBtn">Pedal ON</button>
      <div id="fileName"></div>
    </div>
  </div>

  <script>
    // VARIABLES GLOBALES
    var notesToPlay = [];
    var currentNoteIndex = 0;
    var pedalOn = true; // Estado del pedal. Si true, se mantiene el comportamiento actual.
    var activeNotes = {}; // Guardaremos las notas activas cuando el pedal esté apagado

    // CONFIGURACIÓN DEL AUDIO
    var audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // Filtros (igual que antes)
    var highpass = audioContext.createBiquadFilter();
    highpass.type = "highpass";
    highpass.frequency.value = 200;
    var lowpass = audioContext.createBiquadFilter();
    lowpass.type = "lowpass";
    lowpass.frequency.value = 1500;
    highpass.connect(lowpass);
    lowpass.connect(audioContext.destination);

    var pianoInstrument = null;
    if (window.Soundfont && typeof window.Soundfont.instrument === 'function') {
      Soundfont.instrument(audioContext, 'acoustic_grand_piano', { soundfont: 'MusyngKite' })
        .then(function(piano) {
          pianoInstrument = piano;
          console.log("Instrumento Acoustic Grand Piano (MusyngKite) cargado.");
        })
        .catch(function(error) {
          console.error("Error al cargar el instrumento:", error);
        });
    } else {
      console.error("No se encontró el método instrument en Soundfont.");
    }

    // Duración predeterminada para el modo pedal encendido
    var noteDuration = 3.0;
    var defaultMidiNote = 60; // C4

    function midiNoteToNoteName(midi) {
      var octave = Math.floor(midi / 12) - 1;
      var noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      return noteNames[midi % 12] + octave;
    }

    function computeEffectiveGain(relativeY) {
      var minGain = 0.15;
      var maxGain = 1.0;
      return minGain + (maxGain - minGain) * (1 - relativeY);
    }

    // Función modificada para reproducir nota
    // Si isPedal es true, se usa la duración normal y se programa el fade out.
    // Si es false, se usa una duración larga (simulando nota sostenida) y se devuelve el GainNode para controlarlo.
    function playPianoNoteCustom(gain, midiNote, isPedal) {
      if (!pianoInstrument) {
        console.warn("El instrumento aún no se ha cargado.");
        return;
      }
      var noteName = midiNoteToNoteName(midiNote);
      // Si el pedal está apagado, ponemos una duración larga para poder detenerla manualmente.
      var duration = isPedal ? noteDuration : 60; 
      var source = pianoInstrument.play(noteName, audioContext.currentTime, { 
        gain: gain, 
        duration: duration, 
        velocity: gain * 127 
      });
      var noteGain = audioContext.createGain();
      noteGain.gain.setValueAtTime(gain, audioContext.currentTime);
      source.disconnect();
      source.connect(noteGain);
      if (isPedal) {
        // Modo normal: se programa el fade out (por ejemplo, después de 2 segundos se reduce a 0 en 1 segundo)
        noteGain.gain.setValueAtTime(gain, audioContext.currentTime + 2);
        noteGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 3);
      }
      noteGain.connect(highpass);
      return noteGain; // Se devuelve el objeto para poder detenerlo si es necesario.
    }

    // Manejador para el botón del pedal
    document.getElementById('pedalBtn').addEventListener('click', function() {
      pedalOn = !pedalOn;
      this.textContent = pedalOn ? "Pedal ON" : "Pedal OFF";
      console.log("Estado del pedal:", pedalOn ? "ON" : "OFF");
    });

    // Función para reproducir nota en respuesta al toque
    // Se usa tanto para eventos pointerdown (inicio del toque) como para click.
    function handleTouch(e) {
      var rect = e.currentTarget.getBoundingClientRect();
      var clientY = (e.touches && e.touches.length > 0) ? e.touches[0].clientY : e.clientY;
      var relativeY = (clientY - rect.top) / rect.height;
      var effectiveGain = computeEffectiveGain(relativeY);
      console.log("relativeY:", relativeY, "effectiveGain:", effectiveGain);
      document.body.style.backgroundColor = '#' + Math.floor(Math.random() * 16777215).toString(16);

      // Para simplificar, se reproducirá una nota (o grupo de notas) según el código existente.
      if (notesToPlay.length > 0 && currentNoteIndex < notesToPlay.length) {
        var groupThreshold = 0.001;
        var groupEnd = currentNoteIndex + 1;
        while (groupEnd < notesToPlay.length &&
               Math.abs(notesToPlay[groupEnd].time - notesToPlay[currentNoteIndex].time) < groupThreshold) {
          groupEnd++;
        }
        // Para cada nota del grupo, se reproduce
        for (var i = currentNoteIndex; i < groupEnd; i++) {
          var note = notesToPlay[i];
          // Usamos el parámetro pedalOn para definir el comportamiento
          var noteGain = playPianoNoteCustom(effectiveGain, note.noteNumber, pedalOn);
          // Si el pedal está apagado, guardamos la referencia usando event.pointerId
          if (!pedalOn && e.pointerId !== undefined) {
            activeNotes[e.pointerId] = noteGain;
          }
        }
        currentNoteIndex = groupEnd;
        if (currentNoteIndex >= notesToPlay.length) {
          currentNoteIndex = 0;
        }
      } else {
        // Si no hay notas MIDI, reproducimos una nota por defecto
        var noteGain = playPianoNoteCustom(effectiveGain, defaultMidiNote, pedalOn);
        if (!pedalOn && e.pointerId !== undefined) {
          activeNotes[e.pointerId] = noteGain;
        }
      }
    }

    // Manejador para detener la nota cuando se levanta el dedo (solo si el pedal está apagado)
    function handleTouchEnd(e) {
      if (!pedalOn && e.pointerId !== undefined && activeNotes[e.pointerId]) {
        var noteGain = activeNotes[e.pointerId];
        var now = audioContext.currentTime;
        // Cancelamos cualquier programación anterior y hacemos un fade out rápido (por ejemplo, en 0.1 s)
        noteGain.gain.cancelScheduledValues(now);
        noteGain.gain.setValueAtTime(noteGain.gain.value, now);
        noteGain.gain.linearRampToValueAtTime(0, now + 0.1);
        // Opcional: desconectar después de un corto retardo
        setTimeout(function() {
          noteGain.disconnect();
        }, 150);
        // Eliminamos la referencia
        delete activeNotes[e.pointerId];
      }
    }

    // Asignar eventos para pointerdown y pointerup en el área de toque
    var touchBox = document.getElementById('touchBox');
    if (window.PointerEvent) {
      touchBox.addEventListener('pointerdown', handleTouch);
      touchBox.addEventListener('pointerup', handleTouchEnd);
      touchBox.addEventListener('pointercancel', handleTouchEnd);
    } else if ('ontouchstart' in window) {
      touchBox.addEventListener('touchstart', function(e) {
        e.preventDefault();
        handleTouch(e);
      });
      // En móviles, podrías usar touchend de forma similar
      touchBox.addEventListener('touchend', function(e) {
        // Aquí se puede iterar sobre cada touch terminada y actuar
        // Nota: los eventos touch no incluyen pointerId, por lo que habría que adaptar la estrategia.
      });
    } else {
      touchBox.addEventListener('click', handleTouch);
    }

    // Resto del código para cargar MIDI, pantalla completa, etc. se mantiene igual

    document.getElementById('midiFile').addEventListener('change', function(e) {
      document.getElementById('fileName').textContent = e.target.files[0].name;
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var midi = new MidiFile(e.target.result);
          extractNotesFromMidi(midi);
        } catch (error) {
          console.error("Error al parsear el archivo MIDI:", error);
        }
      };
      reader.readAsBinaryString(e.target.files[0]);
    });

    function loadMidiFromUrl(url, fileName) {
      fetch(url)
        .then(response => response.arrayBuffer())
        .then(data => {
          var reader = new FileReader();
          reader.onload = function(e) {
            try {
              var midi = new MidiFile(e.target.result);
              extractNotesFromMidi(midi);
            } catch (error) {
              console.error("Error al parsear el archivo MIDI:", error);
            }
          };
          reader.readAsBinaryString(new Blob([data]));
          document.getElementById('fileName').textContent = fileName;
        })
        .catch(error => console.error("Error al cargar el MIDI:", error));
    }

    function loadDefaultMidi() {
      const defaultMidiUrl = "https://raw.githubusercontent.com/rafgim2/DreamTwist/main/Beethoven Para Elisa.mid";
      const defaultFileName = "Beethoven Para Elisa.mid";
      loadMidiFromUrl(defaultMidiUrl, defaultFileName);
    }

    function extractNotesFromMidi(midi) {
      notesToPlay = [];
      currentNoteIndex = 0;
      var absoluteTime = 0;
      midi.tracks.forEach(track => {
        absoluteTime = 0;
        track.forEach(event => {
          if (event.deltaTime) {
            absoluteTime += event.deltaTime;
          }
          if (event.subtype === 'noteOn') {
            notesToPlay.push({
              noteNumber: event.noteNumber,
              time: absoluteTime
            });
          }
        });
      });
      notesToPlay.sort((a, b) => a.time - b.time);
      console.log("Notas MIDI extraídas:", notesToPlay);
    }

    document.getElementById('sampleSongs').addEventListener('change', function() {
      if (this.value) {
        const fileName = this.value;
        const url = "https://raw.githubusercontent.com/rafgim2/DreamTwist/main/" + encodeURIComponent(fileName);
        loadMidiFromUrl(url, fileName);
      }
    });

    document.addEventListener('click', function() {
      if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
          console.log("AudioContext reanudado");
        });
      }
    });

    var fullscreenBtn = document.getElementById('fullscreenBtn');
    fullscreenBtn.addEventListener('click', function(e) {
      var elem = document.getElementById('container');
      if (!document.fullscreenElement) {
        elem.requestFullscreen().then(() => {
          fullscreenBtn.textContent = "×";
        }).catch(err => {
          console.error("Error al activar pantalla completa:", err);
        });
      } else {
        document.exitFullscreen().then(() => {
          fullscreenBtn.textContent = "⛶";
        });
      }
      e.stopPropagation();
    });
    document.addEventListener('fullscreenchange', function() {
      if (!document.fullscreenElement) {
        fullscreenBtn.textContent = "⛶";
      }
    });

    window.addEventListener('load', loadDefaultMidi);
  </script>
</body>
</html>
