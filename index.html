<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- Meta viewport con user-scalable=no para evitar zoom accidental -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>DreamTouch - Modo Normal y AR</title>
  <!-- Shim para evitar error de require -->
  <script>
    window.require = function() {};
  </script>
  <!-- Scripts MIDI y soundfont (versión 0.12.0 desde cdn.jsdelivr.net) -->
  <script src="https://cdn.jsdelivr.net/npm/webmidiapishim"></script>
  <script src="https://cdn.jsdelivr.net/npm/webmidi@2"></script>
  <script src="https://cdn.jsdelivr.net/gh/gasman/jasmid@master/stream.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/gasman/jasmid@master/midifile.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
  <!-- A-Frame para AR -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- (Opcional) hand-controls para AR, si el dispositivo lo soporta -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-hand-controls@4.0.1/dist/aframe-hand-controls.min.js"></script>
  <style>
    /* Estilos para el modo normal */
    html {
      transform: scale(0.9);
      transform-origin: top center;
    }
    body {
      background-color: #FFFFFF;
      margin: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      transition: background-color 0.3s ease;
    }
    #container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 6px solid black;
      padding: 30px;
      background-color: #FFFFFF;
      color: black;
      width: 350px;
      box-sizing: border-box;
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 2.8em;
      text-align: center;
    }
    #copyright {
      margin-bottom: 20px;
      margin-top: -20px;
      font-size: 0.9em;
      color: blue;
    }
    /* Botones de pantalla completa y cambio de modo */
    #fullscreenBtn, #modeBtn {
      position: absolute;
      top: 10px;
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      padding: 5px 10px;
      font-size: 1em;
      cursor: pointer;
      z-index: 10;
    }
    #fullscreenBtn { right: 10px; }
    #modeBtn { left: 10px; }
    /* Área de toque (modo normal) */
    #touchBox {
      width: 100%;
      height: 400px;
      background-color: black;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    /* Franjas dinámicas */
    #dynamicMarkingsContainer {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    #dynamicMarkingsContainer > div {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid white;
      font-size: 0.8em;
      color: white;
      background-color: black;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #dynamicMarkingsContainer > div:last-child {
      border-bottom: none;
    }
    /* Controles inferiores */
    #buttons {
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    #loadButton {
      background-color: #90EE90;
      color: black;
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #pedalBtn {
      background-color: #90EE90;
      color: black;
      padding: 5px 10px;
      font-size: 0.9em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #midiFile { display: none; }
    #fileName {
      font-style: italic;
      margin-top: -10px;
      color: black;
    }
    #sampleSongsContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      width: 100%;
    }
    #sampleSongs {
      padding: 5px;
      font-size: 0.8em;
      border-radius: 5px;
      margin-bottom: 20px;
      border: none;
      text-align: center;
    }
    /* AR Scene: se oculta en modo normal */
    #arContainer {
      display: none;
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <!-- Botón para cambiar de modo (Normal / AR) -->
  <button id="modeBtn">Modo AR</button>
  <!-- Modo normal -->
  <div id="container">
    <!-- Botón de pantalla completa -->
    <button id="fullscreenBtn">⛶</button>
    <h1>DreamTouch</h1>
    <div id="copyright">
      <a href="https://www.youtube.com/@rafgim" target="_blank" style="color: inherit; text-decoration: none;">© By Rafael Gimeno</a>
    </div>
    <!-- Área de toque -->
    <div id="touchBox">
      <div id="dynamicMarkingsContainer">
        <div>Fortissimo</div>
        <div>Forte</div>
        <div>Mezzo-forte</div>
        <div>Mezzo-piano</div>
        <div>Piano</div>
        <div>Pianissimo</div>
      </div>
    </div>
    <!-- Controles inferiores -->
    <div id="buttons">
      <label for="midiFile" id="loadButton">
        Cargar Archivo MIDI
        <input type="file" id="midiFile" accept=".mid,.midi,audio/midi,audio/x-midi,application/x-midi">
      </label>
      <div id="sampleSongsContainer">
        <label for="sampleSongs">Canciones de muestra:</label>
        <select id="sampleSongs">
          <option value="">-- Selecciona una canción --</option>
          <option value="Beethoven Para Elisa.mid">Beethoven Para Elisa.mid</option>
          <option value="Beethoven Patética.mid">Beethoven - Patética.mid</option>
          <option value="Handel & Halvorsen Passacaglia.mid">Handel & Halvorsen - Passacaglia.mid</option>
          <option value="R.Korsakov El vuelo del moscardón.mid">R.Korsakov - El vuelo del moscardón.mid</option>
          <option value="Rachmaninoff Concert nº2 Tercer mov.mid">Rachmaninoff - Concert nº2 Tercer mov.mid</option>
          <option value="Satie Gymnopedie n1.mid">Satie - Gymnopedie n1.mid</option>
        </select>
      </div>
      <div id="fileName"></div>
      <!-- Botón de Pedal -->
      <button id="pedalBtn">Pedal ON</button>
    </div>
  </div>

  <!-- Modo AR -->
  <div id="arContainer">
    <a-scene embedded xrweb="mode: ar;" vr-mode-ui="enabled: false" renderer="alpha: true">
      <!-- Cámara con cursor (para simular interacción) -->
      <a-entity id="camera" camera look-controls position="0 1.6 0">
        <a-cursor fuse="true" timeout="500"></a-cursor>
      </a-entity>
      <!-- Contenedor de franjas AR -->
      <a-entity id="arStripes" position="0 1.5 -2">
        <!-- Se crean 6 planos (filas) con nombres de matices -->
        <a-plane class="stripe" data-index="0" position="0 1.0 0" rotation="0 0 0" 
                 width="1.5" height="0.3" color="black"
                 text="value: Fortissimo; align: center; color: white; width: 4;"></a-plane>
        <a-plane class="stripe" data-index="1" position="0 0.7 0" rotation="0 0 0" 
                 width="1.5" height="0.3" color="black"
                 text="value: Forte; align: center; color: white; width: 4;"></a-plane>
        <a-plane class="stripe" data-index="2" position="0 0.4 0" rotation="0 0 0" 
                 width="1.5" height="0.3" color="black"
                 text="value: Mezzo-forte; align: center; color: white; width: 4;"></a-plane>
        <a-plane class="stripe" data-index="3" position="0 0.1 0" rotation="0 0 0" 
                 width="1.5" height="0.3" color="black"
                 text="value: Mezzo-piano; align: center; color: white; width: 4;"></a-plane>
        <a-plane class="stripe" data-index="4" position="0 -0.2 0" rotation="0 0 0" 
                 width="1.5" height="0.3" color="black"
                 text="value: Piano; align: center; color: white; width: 4;"></a-plane>
        <a-plane class="stripe" data-index="5" position="0 -0.5 0" rotation="0 0 0" 
                 width="1.5" height="0.3" color="black"
                 text="value: Pianissimo; align: center; color: white; width: 4;"></a-plane>
      </a-entity>
      <!-- (Opcional) Entidades para hand tracking, si están disponibles -->
      <a-entity hand-controls="hand: left"></a-entity>
      <a-entity hand-controls="hand: right"></a-entity>
    </a-scene>
  </div>

  <script>
    // VARIABLES MIDI Y AUDIO (comunes para ambos modos)
    var notesToPlay = [];
    var currentNoteIndex = 0;
    var audioContext = new (window.AudioContext || window.webkitAudioContext)();
    var highpass = audioContext.createBiquadFilter();
    highpass.type = "highpass";
    highpass.frequency.value = 200;
    var lowpass = audioContext.createBiquadFilter();
    lowpass.type = "lowpass";
    lowpass.frequency.value = 1500;
    highpass.connect(lowpass);
    lowpass.connect(audioContext.destination);
    var pianoInstrument = null;
    if (window.Soundfont && typeof window.Soundfont.instrument === 'function') {
      Soundfont.instrument(audioContext, 'acoustic_grand_piano', { soundfont: 'MusyngKite' })
        .then(function(piano) {
          pianoInstrument = piano;
          console.log("Instrumento Acoustic Grand Piano (MusyngKite) cargado.");
        })
        .catch(function(error) {
          console.error("Error al cargar el instrumento:", error);
        });
    } else {
      console.error("No se encontró el método instrument en Soundfont.");
    }
    var defaultMidiNote = 60; // C4
    var noteDuration = 3.0;
    var pedalOn = true;
    var activeNotes = {};

    // Función para convertir número MIDI a nota (ej. "C4")
    function midiNoteToNoteName(midi) {
      var octave = Math.floor(midi / 12) - 1;
      var noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      return noteNames[midi % 12] + octave;
    }
    function computeEffectiveGain(relativeY) {
      var minGain = 0.15;
      var maxGain = 1.0;
      return minGain + (maxGain - minGain) * (1 - relativeY);
    }
    // Para AR: calcular gain según el índice de la fila (0 = Fortissimo, 5 = Pianissimo)
    function computeGainFromRow(rowIndex, totalRows) {
      // Asignamos: 0 => 1.0, 5 => 0.15, interpolando linealmente
      var minGain = 0.15, maxGain = 1.0;
      return maxGain - (rowIndex/(totalRows - 1))*(maxGain - minGain);
    }
    // Reproducción de nota en modo pedal (se puede adaptar para SIN PEDAL)
    function playPianoNote(gain, midiNote) {
      if (pianoInstrument) {
        var noteName = midiNoteToNoteName(midiNote);
        var source = pianoInstrument.play(noteName, audioContext.currentTime, { 
          gain: gain, 
          duration: noteDuration, 
          velocity: gain * 127 
        });
        var noteGain = audioContext.createGain();
        noteGain.gain.setValueAtTime(gain, audioContext.currentTime);
        source.disconnect();
        source.connect(noteGain);
        noteGain.gain.setValueAtTime(gain, audioContext.currentTime + 2);
        noteGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 3);
        noteGain.connect(highpass);
        console.log("Nota reproducida:", noteName, "gain:", gain);
      } else {
        console.warn("El instrumento aún no se ha cargado.");
      }
    }

    // EVENTOS MODO NORMAL (touchBox)
    function handlePointerDown(e) {
      if (e.pointerType === "mouse" && e.buttons !== 1) return;
      var rect = e.currentTarget.getBoundingClientRect();
      var y = e.clientY;
      var relativeY = (y - rect.top) / rect.height;
      var effectiveGain = computeEffectiveGain(relativeY);
      var randomColor = getRandomColor();
      document.body.style.backgroundColor = randomColor;
      var dynamicContainer = document.getElementById('dynamicMarkingsContainer');
      var rows = dynamicContainer.children;
      for (var i = 0; i < rows.length; i++) {
        rows[i].style.backgroundColor = 'black';
      }
      var containerRect = dynamicContainer.getBoundingClientRect();
      var relativeYInContainer = (e.clientY - containerRect.top) / containerRect.height;
      var rowIndex = Math.floor(relativeYInContainer * rows.length);
      if (rowIndex < 0 || rowIndex >= rows.length) { rowIndex = 0; }
      rows[rowIndex].style.backgroundColor = randomColor;
      // Reproducir nota (para este ejemplo se usa defaultMidiNote)
      playPianoNote(effectiveGain, defaultMidiNote);
    }
    function handlePointerUp(e) {
      // Si fuese SIN PEDAL, se podría detener la nota aquí.
    }
    var touchBox = document.getElementById('touchBox');
    if (window.PointerEvent) {
      touchBox.addEventListener('pointerdown', handlePointerDown);
      touchBox.addEventListener('pointerup', handlePointerUp);
      touchBox.addEventListener('pointercancel', handlePointerUp);
    } else {
      touchBox.addEventListener('touchstart', function(e) {
        e.preventDefault();
        Array.from(e.changedTouches).forEach(function(touch) {
          var fakeEvent = {
            clientY: touch.clientY,
            currentTarget: e.currentTarget,
            pointerId: "touch-" + touch.identifier,
            pointerType: "touch",
            target: e.target
          };
          handlePointerDown(fakeEvent);
        });
      });
      touchBox.addEventListener('touchend', function(e) {
        Array.from(e.changedTouches).forEach(function(touch) {
          var fakeEvent = {
            pointerId: "touch-" + touch.identifier,
            pointerType: "touch",
            target: e.target
          };
          handlePointerUp(fakeEvent);
        });
      });
      touchBox.addEventListener('click', handlePointerDown);
    }

    // Botón de pantalla completa (modo normal)
    var fullscreenBtn = document.getElementById('fullscreenBtn');
    fullscreenBtn.addEventListener('click', function(e) {
      var elem = document.getElementById('container');
      if (!document.fullscreenElement) {
        elem.requestFullscreen().then(() => { fullscreenBtn.textContent = "×"; })
          .catch(err => { console.error("Error al activar pantalla completa:", err); });
      } else {
        document.exitFullscreen().then(() => { fullscreenBtn.textContent = "⛶"; });
      }
      e.stopPropagation();
    });
    document.addEventListener('fullscreenchange', function() {
      if (!document.fullscreenElement) { fullscreenBtn.textContent = "⛶"; }
    });

    // Botón de Pedal (modo normal)
    var pedalBtn = document.getElementById('pedalBtn');
    pedalBtn.addEventListener('click', function() {
      pedalOn = !pedalOn;
      pedalBtn.textContent = pedalOn ? "Pedal ON" : "Pedal OFF";
      pedalBtn.style.backgroundColor = pedalOn ? "#90EE90" : "#ADD8E6";
      console.log("Pedal:", pedalOn ? "ON" : "OFF");
    });

    // Cargar MIDI por defecto
    function loadMidiFromUrl(url, fileName) {
      fetch(url)
        .then(response => response.arrayBuffer())
        .then(data => {
          var reader = new FileReader();
          reader.onload = function(e) {
            try {
              var midi = new MidiFile(e.target.result);
              extractNotesFromMidi(midi);
            } catch (error) {
              console.error("Error al parsear el archivo MIDI:", error);
            }
          };
          reader.readAsBinaryString(new Blob([data]));
          document.getElementById('fileName').textContent = fileName;
        })
        .catch(error => console.error("Error al cargar el MIDI:", error));
    }
    function loadDefaultMidi() {
      const defaultMidiUrl = "https://raw.githubusercontent.com/rafgim2/DreamTwist/main/Handel%20&%20Halvorsen%20Passacaglia.mid";
      const defaultFileName = "Handel & Halvorsen Passacaglia.mid";
      loadMidiFromUrl(defaultMidiUrl, defaultFileName);
    }
    function extractNotesFromMidi(midi) {
      notesToPlay = [];
      currentNoteIndex = 0;
      var absoluteTime = 0;
      midi.tracks.forEach(track => {
        absoluteTime = 0;
        track.forEach(event => {
          if (event.deltaTime) { absoluteTime += event.deltaTime; }
          if (event.subtype === 'noteOn') {
            notesToPlay.push({ noteNumber: event.noteNumber, time: absoluteTime });
          }
        });
      });
      notesToPlay.sort((a, b) => a.time - b.time);
      console.log("Notas MIDI extraídas:", notesToPlay);
    }
    document.getElementById('midiFile').addEventListener('change', function(e) {
      document.getElementById('fileName').textContent = e.target.files[0].name;
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var midi = new MidiFile(e.target.result);
          extractNotesFromMidi(midi);
        } catch (error) {
          console.error("Error al parsear el archivo MIDI:", error);
        }
      };
      reader.readAsBinaryString(e.target.files[0]);
    });
    document.getElementById('sampleSongs').addEventListener('change', function() {
      if (this.value) {
        const fileName = this.value;
        const url = "https://raw.githubusercontent.com/rafgim2/DreamTwist/main/" + encodeURIComponent(fileName);
        loadMidiFromUrl(url, fileName);
      }
    });
    function getRandomColor() {
      return '#' + Math.floor(Math.random() * 16777215).toString(16);
    }

    // EVENTOS MODO AR
    // Se agrega un listener para cada stripe en la escena AR
    function setupARStripes() {
      var arStripes = document.querySelectorAll('.stripe');
      arStripes.forEach(function(stripe) {
        stripe.addEventListener('click', function (evt) {
          // Reiniciar todas a negro
          arStripes.forEach(function(s) {
            s.setAttribute('material', 'color', 'black');
          });
          var randomColor = getRandomColor();
          // Asignar color al stripe tocado
          stripe.setAttribute('material', 'color', randomColor);
          // Obtener el índice de la fila y calcular gain
          var rowIndex = parseInt(stripe.getAttribute('data-index'));
          var gain = computeGainFromRow(rowIndex, arStripes.length);
          // Reproducir nota (usando defaultMidiNote)
          playPianoNote(gain, defaultMidiNote);
        });
      });
    }
    // Cuando carga el AR scene, se configuran los eventos
    window.addEventListener('load', function() {
      loadDefaultMidi();
      setupARStripes();
    });

    // Botón para cambiar entre modos
    var modeBtn = document.getElementById('modeBtn');
    modeBtn.addEventListener('click', function() {
      var container = document.getElementById('container');
      var arContainer = document.getElementById('arContainer');
      // Si se está en modo normal, cambiar a AR
      if (container.style.display !== "none") {
        container.style.display = "none";
        arContainer.style.display = "block";
        modeBtn.textContent = "Modo Normal";
      } else {
        container.style.display = "flex";
        arContainer.style.display = "none";
        modeBtn.textContent = "Modo AR";
      }
    });
  </script>
</body>
</html>
