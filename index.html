<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Demo AR Hand Tracking</title>
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <style>
    body { margin: 0; overflow: hidden; }
    #startARBtn {
      position: absolute;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: orange; color: #000;
      font-weight: bold; cursor: pointer;
      border: none; border-radius: 8px;
      z-index: 10;
    }
    #info {
      position: absolute;
      bottom: 10px; left: 0; right: 0;
      text-align: center; color: white;
      font-family: sans-serif; font-size: 14px;
      z-index: 10;
    }
  </style>
</head>
<body>
<button id="startARBtn">INICIAR AR</button>
<div id="info">Coloca tus manos delante de la cámara. Si tu dispositivo/navegador soporta Hand Tracking, podrás “tocar” los paneles.</div>
<script type="module">
/* IMPORTAMOS THREE Y ARButton EXACTAMENTE COMO EN TU EJEMPLO. */
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.module.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.138.0/examples/jsm/webxr/ARButton.js';

/* VARIABLES GLOBALES */
let camera, scene, renderer;
let panels = []; // Nuestros "paneles" en AR
let handSelectActive = false; // bandera para no disparar el toque de forma continua
let collisionDistance = 0.1; // umbral de distancia para colisión mano-panel

function initAR() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  // LUZ
  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  light.position.set(0.5, 1, 0.25);
  scene.add(light);

  // AJUSTE AL REDIMENSIONAR
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }, false);

  // BOTÓN AR
  const sessionInit = {
    requiredFeatures: ['hit-test'], // En móviles
    optionalFeatures: ['hand-tracking'] // Para gafas Meta/Oculus Quest
  };
  const arButton = ARButton.createButton(renderer, sessionInit);
  // Ocultamos el que crea ARButton por defecto
  arButton.style.display = 'none';

  // Creación de paneles
  createPanels();

  // ESCUCHAR LA SESIÓN XR
  renderer.xr.addEventListener('sessionstart', onSessionStart);

  // Bucle
  renderer.setAnimationLoop(animate);
}

function createPanels() {
  // Creamos 3 paneles de ejemplo, cada uno un Plane con color distinto
  const geometry = new THREE.PlaneGeometry(0.2, 0.2);
  let colors = [0xff0000, 0x00ff00, 0x0000ff];
  for (let i = 0; i < 3; i++) {
    const material = new THREE.MeshBasicMaterial({ color: colors[i] });
    const mesh = new THREE.Mesh(geometry, material);
    // Los posicionamos arriba
    // i=0 => Y=0.3, i=1 => Y=0.0, i=2 => Y=-0.3
    let yPos = 0.3 - i*0.3;
    mesh.position.set(0, yPos, -0.8); // un poco más cerca
    scene.add(mesh);
    panels.push(mesh);
  }
}

function onSessionStart() {
  // Sesión AR iniciada
  console.log("Sesión AR iniciada");
}

/* BUCLE PRINCIPAL */
function animate(time, xrFrame) {
  renderer.render(scene, camera);

  // Revisar hand tracking
  if (renderer.xr.isPresenting) {
    const session = renderer.xr.getSession();
    if (session && xrFrame) {
      handleHandTracking(session, xrFrame);
    }
  }
}

/* FUNCIÓN QUE REVISA TODAS LAS MANOS Y SUS JOINTS */
function handleHandTracking(session, xrFrame) {
  // Para cada inputSource, si tiene .hand, revisamos TODOS sus joints
  let collisionDetected = false;
  for (const inputSource of session.inputSources) {
    if (!inputSource.hand) continue; // no es una mano

    // Recorrer todos los joints
    for (const jointSpace of inputSource.hand.values()) {
      // Ver si es visible
      if (!jointSpace) continue;
      const jointPose = xrFrame.getJointPose(jointSpace, renderer.xr.getReferenceSpace());
      if (!jointPose || !jointPose.transform) continue;

      // Posición mundial del joint
      const jointPos = new THREE.Vector3(
        jointPose.transform.position.x,
        jointPose.transform.position.y,
        jointPose.transform.position.z
      );

      // Revisar contra cada panel si la distancia < collisionDistance
      for (let panel of panels) {
        // Obtener posición del panel
        const panelPos = new THREE.Vector3();
        panel.getWorldPosition(panelPos);
        // Calcular distancia
        const dist = jointPos.distanceTo(panelPos);
        if (dist < collisionDistance) {
          collisionDetected = true;
          // Disparamos "colisión" si no se había disparado ya
          if (!handSelectActive) {
            handSelectActive = true;
            onPanelTouched(panel);
          }
          // Como ya detectamos colisión, no seguimos buscando en este frame
          return;
        }
      }
    }
  }

  // Si no hubo colisión en este frame, reseteamos la bandera
  if (!collisionDetected) {
    handSelectActive = false;
  }
}

/* ACCIÓN AL "TOCAR" UN PANEL */
function onPanelTouched(panel) {
  console.log("Panel tocado, color = ", panel.material.color.getHexString());
  // Por ejemplo, invertir el color
  let oldColor = panel.material.color.getHex();
  let newColor = (oldColor ^ 0xffffff); // XOR
  panel.material.color.setHex(newColor);

  // Aquí pondrías tu lógica de reproducir la nota MIDI, etc.
  // Ejemplo:
  // window.playPianoNote(1.0, 60);  // C4 con gain 1.0
}

/* EVENTO BOTÓN: Iniciar AR */
document.getElementById('startARBtn').addEventListener('click', async () => {
  // Chequeamos si AR es soportado
  if (navigator.xr) {
    try {
      let supported = await navigator.xr.isSessionSupported('immersive-ar');
      if (supported) {
        // Iniciamos
        document.getElementById('startARBtn').remove();
        initAR();
      } else {
        alert("AR no soportado en este navegador/dispositivo.");
      }
    } catch(e) {
      alert("Error intentando iniciar AR: " + e);
      console.error(e);
    }
  } else {
    alert("Este navegador no soporta WebXR.");
  }
});
</script>
</body>
</html>
