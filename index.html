<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- Meta viewport con user-scalable=no para evitar zoom accidental -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>DreamTouch AR</title>
  <!-- Shim para evitar error de require -->
  <script>
    window.require = function() {};
  </script>
  <!-- Incluimos Three.js (no módulo) -->
  <script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
  <!-- Estilos -->
  <style>
    /* Estilos generales */
    html {
      transform: scale(0.9);
      transform-origin: top center;
    }
    body {
      background-color: #FFFFFF;
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* Contenedor original (modo no AR) */
    #container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 6px solid black;
      padding: 30px;
      background-color: #FFFFFF;
      color: black;
      width: 350px;
      box-sizing: border-box;
      margin-top: 20px;
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 2.8em;
      text-align: center;
    }
    #copyright {
      margin-bottom: 20px;
      margin-top: -20px;
      font-size: 0.9em;
      color: blue;
    }
    /* Botón de pantalla completa (del modo no AR) */
    #fullscreenBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      padding: 5px 10px;
      font-size: 1em;
      cursor: pointer;
      z-index: 10;
    }
    /* Área de toque: fondo negro, dividido en 6 franjas */
    #touchBox {
      width: 100%;
      height: 400px;
      background-color: black;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    /* Franjas de matices */
    #dynamicMarkingsContainer {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    #dynamicMarkingsContainer > div {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid white;
      font-size: 0.8em;
      color: white;
      background-color: black;
      transition: background-color 0.3s ease;
    }
    #dynamicMarkingsContainer > div:last-child {
      border-bottom: none;
    }
    /* Controles inferiores */
    #buttons {
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    #loadButton {
      background-color: #90EE90;
      color: black;
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #pedalBtn {
      background-color: #90EE90;
      color: black;
      padding: 5px 10px;
      font-size: 0.9em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #midiFile {
      display: none;
    }
    #fileName {
      font-style: italic;
      margin-top: -10px;
      color: black;
    }
    #sampleSongsContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      width: 100%;
    }
    #sampleSongs {
      padding: 5px;
      font-size: 0.8em;
      border-radius: 5px;
      margin-bottom: 20px;
      border: none;
      text-align: center;
    }
    /* Botón START AR (siempre visible en la parte inferior) */
    #startARBtn {
      margin-top: 20px;
      padding: 15px 25px;
      font-size: 1.2em;
      border: none;
      border-radius: 10px;
      background-color: #FF9800;
      color: white;
      cursor: pointer;
    }
    /* Contenedor para el AR (oculto en modo normal) */
    #arContainer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      z-index: 100;
    }
  </style>
</head>
<body>
  <!-- Interfaz original -->
  <div id="container">
    <button id="fullscreenBtn">⛶</button>
    <h1>DreamTouch</h1>
    <div id="copyright">
      <a href="https://www.youtube.com/@rafgim" target="_blank" style="color: inherit; text-decoration: none;">© By Rafael Gimeno</a>
    </div>
    <div id="touchBox">
      <div id="dynamicMarkingsContainer">
        <div>Fortissimo</div>
        <div>Forte</div>
        <div>Mezzo-forte</div>
        <div>Mezzo-piano</div>
        <div>Piano</div>
        <div>Pianissimo</div>
      </div>
    </div>
    <div id="buttons">
      <label for="midiFile" id="loadButton">
        Cargar Archivo MIDI
        <input type="file" id="midiFile" accept=".mid,.midi,audio/midi,audio/x-midi,application/x-midi">
      </label>
      <div id="sampleSongsContainer">
        <label for="sampleSongs">Canciones de muestra:</label>
        <select id="sampleSongs">
          <option value="">-- Selecciona una canción --</option>
          <option value="Beethoven Para Elisa.mid">Beethoven Para Elisa.mid</option>
          <option value="Beethoven Patética.mid">Beethoven - Patética.mid</option>
          <option value="Handel & Halvorsen Passacaglia.mid">Handel & Halvorsen - Passacaglia.mid</option>
          <option value="R.Korsakov El vuelo del moscardón.mid">R.Korsakov - El vuelo del moscardón.mid</option>
          <option value="Rachmaninoff Concert nº2 Tercer mov.mid">Rachmaninoff - Concert nº2 Tercer mov.mid</option>
          <option value="Satie Gymnopedie n1.mid">Satie - Gymnopedie n1.mid</option>
        </select>
      </div>
      <div id="fileName"></div>
      <button id="pedalBtn">Pedal ON</button>
    </div>
  </div>

  <!-- Botón para iniciar AR (visible en modo normal) -->
  <button id="startARBtn">START AR</button>

  <!-- Contenedor para la sesión AR -->
  <div id="arContainer"></div>

  <!-- Scripts de la aplicación normal (modo táctil/móvil) -->
  <script>
    // VARIABLES PARA LAS NOTAS MIDI (código original, se omiten funciones de audio por brevedad)
    var notesToPlay = [];
    var currentNoteIndex = 0;
    var pedalOn = true;
    var activeNotes = {};

    // Función auxiliar para generar un color aleatorio
    function getRandomColor() {
      return '#' + Math.floor(Math.random() * 16777215).toString(16);
    }

    // Función para manejar el toque en la interfaz normal
    function handlePointerDown(e) {
      if (e.pointerType === "mouse" && e.buttons !== 1) return;
      var rect = e.currentTarget.getBoundingClientRect();
      var y = e.clientY;
      var relativeY = (y - rect.top) / rect.height;
      var randomColor = getRandomColor();
      document.body.style.backgroundColor = randomColor;
      var dynamicContainer = document.getElementById('dynamicMarkingsContainer');
      var rows = dynamicContainer.children;
      // Reiniciamos todas las filas a negro
      for (var i = 0; i < rows.length; i++) {
        rows[i].style.backgroundColor = 'black';
      }
      var containerRect = dynamicContainer.getBoundingClientRect();
      var relativeYInContainer = (e.clientY - containerRect.top) / containerRect.height;
      var rowIndex = Math.floor(relativeYInContainer * rows.length);
      if (rowIndex < 0 || rowIndex >= rows.length) rowIndex = 0;
      rows[rowIndex].style.backgroundColor = randomColor;
      // Aquí se podrían reproducir notas MIDI, etc.
      console.log("Fila " + rowIndex + " coloreada con " + randomColor);
    }

    // Asignamos el evento a la caja de toques (modo no AR)
    var touchBox = document.getElementById('touchBox');
    if (window.PointerEvent) {
      touchBox.addEventListener('pointerdown', handlePointerDown);
    } else {
      touchBox.addEventListener('touchstart', function(e) {
        e.preventDefault();
        Array.from(e.changedTouches).forEach(function(touch) {
          handlePointerDown({clientY: touch.clientY, currentTarget: e.currentTarget, pointerType: "touch"});
        });
      });
    }
  </script>

  <!-- Scripts para AR (usamos módulo para aprovechar ARButton y WebXR) -->
  <script type="module">
    import { ARButton } from "https://unpkg.com/three@0.150.1/examples/jsm/webxr/ARButton.js";

    let camera, scene, renderer, controller;
    const stripeMeshes = [];
    const stripeCount = 6; // 6 franjas

    function initAR() {
      // Creamos el renderer con WebXR habilitado
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      // Colocamos el canvas en el contenedor AR
      const arContainer = document.getElementById('arContainer');
      arContainer.appendChild(renderer.domElement);

      // Creamos la escena y cámara
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
      
      // Creamos 6 franjas horizontales (planos) y los colocamos en el espacio
      const stripeWidth = 1;    // ancho en metros
      const stripeHeight = 0.1; // altura de cada franja
      const gap = 0.02;         // separación entre franjas
      const totalHeight = stripeCount * (stripeHeight + gap);
      const startY = totalHeight / 2 - stripeHeight/2;
      for (let i = 0; i < stripeCount; i++) {
        const geometry = new THREE.PlaneGeometry(stripeWidth, stripeHeight);
        // Material negro por defecto
        const material = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide });
        const mesh = new THREE.Mesh(geometry, material);
        // Ubicamos verticalmente
        mesh.position.set(0, startY - i*(stripeHeight + gap), -1.5);
        scene.add(mesh);
        stripeMeshes.push(mesh);
      }
      
      // Controlador para detectar selecciones (toques o handtracking select)
      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);
      
      // Añadimos el ARButton para iniciar la sesión AR
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));
      
      renderer.setAnimationLoop(render);
    }

    // Al seleccionar (toque/handtracking), reiniciamos todas las franjas a negro y coloreamos la tocada
    function onSelect(event) {
      // Realizamos un raycast desde el controlador
      const tempMatrix = new THREE.Matrix4();
      tempMatrix.identity().extractRotation(controller.matrixWorld);
      const raycaster = new THREE.Raycaster();
      raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
      raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);
      const intersects = raycaster.intersectObjects(stripeMeshes);
      if (intersects.length > 0) {
        // Reiniciamos todas las franjas
        stripeMeshes.forEach(mesh => {
          mesh.material.color.set(0x000000);
        });
        // Coloreamos la primera intersección
        const randomColor = new THREE.Color(Math.random(), Math.random(), Math.random());
        intersects[0].object.material.color.copy(randomColor);
        console.log("Franja tocada, nuevo color:", randomColor.getStyle());
      }
    }

    function render() {
      renderer.render(scene, camera);
    }

    // Función para iniciar el modo AR y ocultar la interfaz original
    function startAR() {
      document.getElementById('container').style.display = 'none';
      document.getElementById('startARBtn').style.display = 'none';
      document.getElementById('arContainer').style.display = 'block';
      initAR();
    }

    // Asignamos el evento al botón START AR
    document.getElementById('startARBtn').addEventListener('click', startAR);
  </script>
</body>
</html>
